<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rapot - Ponpes Al-Ikhlas</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Library untuk Screenshot & PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- 1. CONFIGURATION & RESET --- */
        :root {
            /* TEMA PUTRA (Default) */
            --primary: #1a4d3e;   /* Hijau Tua */
            --secondary: #d4af37; /* Emas */
            --bg: #f4f7f6;
            --text: #333;
            --white: #ffffff;
            --radius: 12px;
        }

        /* TEMA PUTRI (Ustadzah / Santriwati) */
        body.theme-female {
            --primary: #6a1b9a;   /* Ungu */
            --secondary: #ff80ab; /* Pink */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        html, body { height: 100%; overflow-x: hidden; }
        body { background-color: var(--bg); color: var(--text); }
        .hidden { display: none !important; }

        /* --- 2. LOGIN PAGE --- */
        #login-section {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: linear-gradient(135deg, var(--primary), #000);
            z-index: 9999; transition: background 0.5s;
        }
        .login-card {
            background: var(--white); padding: 40px; border-radius: var(--radius);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 100%; max-width: 400px; text-align: center;
            border-top: 5px solid var(--secondary);
        }
        .login-logo img { width: 120px; height: auto; margin-bottom: 15px; object-fit: contain; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            margin-top: 5px; background: #f9f9f9; outline: none;
        }
        .btn-full {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: 0.3s; margin-top: 15px;
        }
        .btn-full:hover { opacity: 0.9; transform: scale(0.98); }

        /* --- 3. DASHBOARD --- */
        .dashboard-container { max-width: 1100px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--white); padding: 15px 20px; border-radius: var(--radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px;
        }
        .nav-brand { font-weight: 700; color: var(--primary); font-size: 1.2rem; }
        .btn-logout { color: #c0392b; cursor: pointer; font-weight: 600; }

        .banner {
            background: linear-gradient(to right, var(--primary), #333); color: white;
            padding: 30px; border-radius: var(--radius); margin-bottom: 25px;
        }

        .grid-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .card {
            background: var(--white); padding: 25px; border-radius: var(--radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; justify-content: space-between; height: 100%;
        }
        .card:hover { transform: translateY(-5px); border-bottom: 3px solid var(--secondary); }
        .card-icon { font-size: 2rem; color: var(--primary); margin-bottom: 15px; }
        .btn-card { margin-top: auto; padding: 8px; border: 1px solid var(--primary); color: var(--primary); border-radius: 6px; text-align: center; font-size: 0.85rem; }
        .btn-card:hover { background: var(--primary); color: white; }

        /* --- 4. MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100; opacity: 0; pointer-events: none;
            display: flex; justify-content: center; align-items: center; padding: 20px;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: white; width: 100%; max-width: 900px; padding: 25px;
            border-radius: var(--radius); position: relative; max-height: 90vh; overflow-y: auto;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #888; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        th { background: #f4f7f6; color: var(--primary); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-lunas { background: #d4edda; color: #155724; }
        .badge-belum { background: #f8d7da; color: #721c24; }
        .edit-month-btn { color: #888; cursor: pointer; font-size: 0.8rem; margin-left: 5px; }
        .radio-group { display: flex; gap: 20px; margin-top: 10px; }
        .radio-group label { cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* Search List Style */
        #list-santri-display { list-style: none; padding: 0; margin-top: 10px; }
        #list-santri-display li {
            background: #f9f9f9; padding: 10px; border-radius: 6px; 
            margin-bottom: 5px; border-left: 4px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-delete { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; }
        .btn-delete:hover { background: #c0392b; }

        /* --- 5. PRINTABLE AREA --- */
        #printable-area {
            position: absolute; top: -9999px; left: -9999px;
            width: 794px; min-height: 1123px; background: white; color: black;
            font-family: 'Arial', sans-serif; padding: 40px 50px 80px 50px;
            box-sizing: border-box; overflow: visible; 
        }
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; opacity: 0.08; z-index: 0; pointer-events: none;
        }
        
        .rapot-content { position: relative; z-index: 1; }

        .kop-header {
            position: relative; text-align: center; border-bottom: 4px double #000;
            padding-bottom: 15px; margin-bottom: 25px; min-height: 110px;
        }
        .kop-logo { position: absolute; left: 0; top: 0; width: 110px; height: auto; }
        .kop-text { margin: 0 20px; padding-left: 80px; }
        .kop-text h2 { font-family: 'Times New Roman', serif; font-size: 20pt; font-weight: 900; margin: 0; text-transform: uppercase; line-height: 1.2; color: #000; }
        .kop-text p { font-family: 'Times New Roman', serif; font-size: 11pt; margin: 3px 0; color: #000; line-height: 1.4; }

        .judul-box { border: 2px solid black; text-align: center; font-weight: bold; padding: 8px; margin: 20px 0; font-size: 12pt; text-transform: uppercase; letter-spacing: 1px; }

        .info-table { width: 100%; margin-bottom: 20px; font-size: 11pt; border: none; }
        .info-table td { padding: 4px; border: none; vertical-align: top; }
        .label-col { width: 130px; }
        .colon-col { width: 15px; text-align: center; }

        .nilai-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; }
        .nilai-table th, .nilai-table td { border: 1px solid black; padding: 7px; text-align: center; }
        .nilai-table th { background-color: #f0f0f0; }
        .nilai-table .text-left { text-align: left; padding-left: 10px; }
        .nilai-table .sub-header { background-color: #eaeaea; font-weight: bold; text-align: left; padding-left: 10px; }
        
        .catatan-box { border: 1px solid black; padding: 10px; margin-bottom: 15px; font-size: 10pt; min-height: 60px; font-style: italic; }
        .kenaikan-box { border: 1px solid black; padding: 10px; margin-bottom: 30px; font-size: 10pt; font-weight: bold; text-align: center; background: #fafafa; }

        .signature-section { display: flex; justify-content: space-between; padding: 0 40px; font-size: 11pt; margin-top: 40px; page-break-inside: avoid; }
        .sig-space { height: 80px; }
        
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px;
            transform: translateX(-50%);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="toast">Notifikasi</div>

    <!-- 1. LOGIN SECTION -->
    <div id="login-section">
        <div class="login-card">
            <div class="login-logo">
                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgkIHE-f2ce5OWCDnkK3CzjC-WCYAbCgs2nEQVWEkNLHXZvPQhYo-L4DiwymKv8quQLNQC_frI0OFbxfhF0CRheSmpkBsbV6obruYMBynML1T7sOUD5_-K_W8WiOMO3Via6ahiQ3bmbNF9myL_CoaR603qIzfSNJm2mzDSJfNtCJamvsJGmgEgYalnvflE" alt="Logo Ponpes">
            </div>
            
            <h2 id="login-title" style="color: var(--primary); margin-bottom: 5px;">MA'HAD DARUSSALAM</h2>
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 25px;">Sistem Akademik Pesantren Digital</p>
            
            <input type="text" id="usernameInput" class="form-control" placeholder="Username / NIS Santri">
            <input type="password" id="passwordInput" class="form-control" placeholder="Password">
            
            <button class="btn-full" onclick="handleLogin()">MASUK APLIKASI</button>
            <p style="margin-top: 20px; font-size: 0.75rem; color: #999;">
                <b>Info Login:</b><br>
                Ustadz/Ustadzah: Password <code>932</code><br>
                Wali Santri: Password <code>123</code>
            </p>
        </div>
    </div>

    <!-- 2. DASHBOARD STAFF (USTADZ / USTADZAH) -->
    <div id="staff-dashboard" class="hidden dashboard-container">
        <div class="navbar">
            <div class="nav-brand">
                <i class="fas fa-mosque"></i> <span id="staff-title">Panel Staff</span>
            </div>
            <div class="btn-logout" onclick="logout()">Keluar <i class="fas fa-sign-out-alt"></i></div>
        </div>
        
        <div class="banner">
            <h1 id="banner-salam">Ahlan Wa Sahlan</h1>
            <p>Kelola data santri, input nilai, catatan, dan kenaikan kelas.</p>
        </div>

        <div class="grid-menu">
            <div class="card" onclick="openModal('modal-data-santri')">
                <div>
                    <div class="card-icon"><i class="fas fa-users-cog"></i></div>
                    <h3>Data Santri</h3>
                    <p>Tambah dan hapus data santri.</p>
                </div>
                <div class="btn-card">Kelola Data</div>
            </div>
            <div class="card" onclick="bukaModalInputNilai()">
                <div>
                    <div class="card-icon"><i class="fas fa-edit"></i></div>
                    <h3>Input Nilai</h3>
                    <p>Input Nilai, Catatan & Status Kenaikan.</p>
                </div>
                <div class="btn-card">Buka Form</div>
            </div>
            <div class="card" onclick="bukaModalKelolaSPP()">
                <div>
                    <div class="card-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h3>Kelola SPP</h3>
                    <p>Update pembayaran & edit bulan.</p>
                </div>
                <div class="btn-card">Update Keuangan</div>
            </div>
            <div class="card" onclick="openModal('modal-buat-pengumuman')">
                <div>
                    <div class="card-icon"><i class="fas fa-bullhorn"></i></div>
                    <h3>Buat Pengumuman</h3>
                    <p>Kirim info ke Wali Santri.</p>
                </div>
                <div class="btn-card">Tulis Info</div>
            </div>
             <div class="card" onclick="setupPreviewUstadz()">
                <div>
                    <div class="card-icon"><i class="fas fa-print"></i></div>
                    <h3>Cetak Rapot</h3>
                    <p>Preview, lalu download PDF/JPG.</p>
                </div>
                <div class="btn-card">Lihat Rapot</div>
            </div>
        </div>
    </div>

    <!-- 3. DASHBOARD WALI -->
    <div id="wali-dashboard" class="hidden dashboard-container">
        <div class="navbar">
            <div class="nav-brand">
                <i class="fas fa-user-friends"></i> <span id="wali-role-title">Wali Santri</span>
            </div>
            <div class="btn-logout" onclick="logout()">Keluar <i class="fas fa-sign-out-alt"></i></div>
        </div>
        
        <div class="banner" style="background: linear-gradient(to right, var(--secondary), #b89626);">
            <h1 style="color: #fff;">Wali dari: <span id="wali-nama-santri">...</span></h1>
            <p style="color: #fff;">Kelas 7A - Asrama</p>
        </div>

        <div class="grid-menu">
            <div class="card" onclick="generateRapotForWali()">
                <div>
                    <div class="card-icon"><i class="fas fa-file-pdf"></i></div>
                    <h3>Rapot Digital</h3>
                    <p>Lihat dan unduh hasil belajar.</p>
                </div>
                <div class="btn-card">Buka Rapot</div>
            </div>
            <div class="card" onclick="lihatSPPWali()">
                <div>
                    <div class="card-icon"><i class="fas fa-wallet"></i></div>
                    <h3>Cek SPP</h3>
                    <p>Status pembayaran bulanan.</p>
                </div>
                <div class="btn-card">Lihat Tagihan</div>
            </div>
            <div class="card" onclick="bukaModalPengumumanWali()">
                <div>
                    <div class="card-icon"><i class="fas fa-envelope-open-text"></i></div>
                    <h3>Info Pondok</h3>
                    <p>Berita terbaru dari Pondok.</p>
                </div>
                <div class="btn-card">Baca Info</div>
            </div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- MODAL 1: KELOLA DATA SANTRI (FITUR BARU SEARCH & HAPUS) -->
    <div id="modal-data-santri" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3><i class="fas fa-user-plus"></i> Kelola Data Santri</h3>
            
            <!-- Form Tambah -->
            <div style="margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                <label style="font-size:0.9rem; font-weight:600;">Nama Santri</label>
                <input type="text" id="new-nama" class="form-control" placeholder="Nama Lengkap">
                <label style="font-size:0.9rem; font-weight:600; margin-top:10px; display:block;">NIS (Unik)</label>
                <input type="number" id="new-nis" class="form-control" placeholder="Nomor Induk">
                
                <!-- Otomatis mendeteksi role untuk display, tapi tetap form untuk input -->
                <label style="font-size:0.9rem; font-weight:600; margin-top:10px; display:block;">Kategori</label>
                <select id="new-gender" class="form-control">
                    <option value="putra">Putra (Santri)</option>
                    <option value="putri">Putri (Santriwati)</option>
                </select>
                <button class="btn-full" onclick="tambahSantriBaru()">Simpan Data</button>
            </div>

            <!-- List Search & Delete -->
            <div style="margin-top:20px;">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    Daftar Santri: 
                    <span style="font-size:0.8rem; font-weight:normal; color:#666;" id="count-santri"></span>
                </h4>
                
                <!-- Search Bar -->
                <input type="search" id="search-santri" class="form-control" 
                       placeholder="Cari nama atau NIS..." onkeyup="filterSantriList()" 
                       style="margin: 10px 0; border: 1px solid var(--primary);">

                <ul id="list-santri-display">
                    <!-- List diisi JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- MODAL 2: INPUT NILAI -->
    <div id="modal-input-nilai" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3><i class="fas fa-edit"></i> Input Nilai & Catatan</h3>
            <div style="margin: 15px 0;">
                <label>Pilih Santri:</label>
                <select id="select-santri-input" class="form-control" onchange="loadNilaiToForm()"></select>
            </div>
            
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <table id="tabel-input-nilai">
                    <thead>
                        <tr>
                            <th>Mata Pelajaran</th>
                            <th style="width:100px;">Nilai</th>
                            <th>Pilih Predikat</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-nilai-input"></tbody>
                </table>
            </div>

            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px;">
                <label style="font-weight: bold;">Catatan / Keterangan Ustadz/Ustadzah:</label>
                <textarea id="input-catatan" class="form-control" placeholder="Tulis catatan untuk wali santri..." style="height: 60px;"></textarea>
                
                <label style="font-weight: bold; margin-top: 15px; display: block;">Keputusan Kenaikan Kelas:</label>
                <div class="radio-group">
                    <label><input type="radio" name="naikKelas" value="naik" checked> Naik Kelas</label>
                    <label><input type="radio" name="naikKelas" value="tinggal"> Tidak Naik Kelas</label>
                </div>
            </div>

            <button class="btn-full" onclick="simpanDataNilai()">Simpan Semua Data</button>
        </div>
    </div>

    <!-- MODAL 3: KELOLA SPP -->
    <div id="modal-kelola-spp" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Kelola Tagihan SPP</h3>
                <button style="padding:5px 10px; background:var(--secondary); border:none; border-radius:4px; cursor:pointer; color:#fff;" onclick="tambahBulanSPP()">
                    <i class="fas fa-plus"></i> Tambah Tagihan
                </button>
            </div>
            <div style="max-height:300px; overflow-y:auto; margin-top:10px;">
                <table>
                    <thead><tr><th>Nama Santri</th><th>Bulan</th><th>Status</th><th>Aksi</th></tr></thead>
                    <tbody id="tbody-spp-ustadz"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL 4: PREVIEW RAPOT -->
    <div id="modal-preview-rapot" class="modal-overlay">
        <div class="modal-content" style="text-align: center; max-width: 900px;">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>Preview Hasil Rapot</h3>
            <div id="loading-text" style="padding: 20px;">Memproses Preview...</div>
            <div id="rapot-image-container" style="margin: 15px auto; border: 1px solid #ddd; padding: 5px; max-height: 60vh; overflow-y:auto; display: flex; justify-content: center;"></div>
            <div id="action-buttons" style="display:none; gap: 10px; justify-content: center; margin-top: 15px;">
                <button class="btn-full" onclick="downloadJPG()" style="width: auto; background: #2980b9; margin-top:0;">Download JPG</button>
                <button class="btn-full" onclick="downloadPDF()" style="width: auto; background: #c0392b; margin-top:0;">Download PDF</button>
            </div>
        </div>
    </div>

    <div id="modal-spp-wali" class="modal-overlay"><div class="modal-content"><span class="close-modal" onclick="closeAllModals()">&times;</span><h3>Riwayat SPP</h3><table><thead><tr><th>Bulan</th><th>Nominal</th><th>Status</th></tr></thead><tbody id="tbody-spp-wali"></tbody></table></div></div>
    
    <div id="modal-buat-pengumuman" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>Buat Pengumuman</h3>
            <div class="form-group"><label>Judul</label><input type="text" id="judul-pengumuman" class="form-control"></div>
            <div class="form-group"><label>Isi Pesan</label><textarea id="isi-pengumuman" class="form-control"></textarea></div>
            <button class="btn-full" onclick="simpanPengumuman()">Kirim</button>
        </div>
    </div>
    
    <div id="modal-lihat-pengumuman" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAllModals()">&times;</span>
            <h3>Papan Informasi</h3>
            <div id="container-pengumuman-wali" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- ================= AREA CETAK ================= -->
    <div id="printable-area">
        <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgkIHE-f2ce5OWCDnkK3CzjC-WCYAbCgs2nEQVWEkNLHXZvPQhYo-L4DiwymKv8quQLNQC_frI0OFbxfhF0CRheSmpkBsbV6obruYMBynML1T7sOUD5_-K_W8WiOMO3Via6ahiQ3bmbNF9myL_CoaR603qIzfSNJm2mzDSJfNtCJamvsJGmgEgYalnvflE" class="watermark" alt="Watermark">

        <div class="rapot-content">
            <div class="kop-header">
                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgkIHE-f2ce5OWCDnkK3CzjC-WCYAbCgs2nEQVWEkNLHXZvPQhYo-L4DiwymKv8quQLNQC_frI0OFbxfhF0CRheSmpkBsbV6obruYMBynML1T7sOUD5_-K_W8WiOMO3Via6ahiQ3bmbNF9myL_CoaR603qIzfSNJm2mzDSJfNtCJamvsJGmgEgYalnvflE" class="kop-logo" alt="Logo">
                <div class="kop-text">
                    <h2>PONDOK PESANTREN</h2>
                    <h2>DARUSSALAM AS-SALAFY</h2>
                    <p>Alamat: Bulak, Nambangan, Kec. Selogiri</p>
                    <p>Kabupaten Wonogiri, Jawa Tengah</p>
                    <p>Nomor Statistik Pesantren: 510065020003</p>
                </div>
            </div>

            <div class="judul-box">PROFIL DAN RAPOR SANTRI</div>

            <table class="info-table">
                <tr><td class="label-col">Nama</td><td class="colon-col">:</td><td><b id="print-nama">...</b></td></tr>
                <tr><td class="label-col">Kelas</td><td class="colon-col">:</td><td>7A (Tsanawiyah)</td></tr>
                <tr><td class="label-col">NIS</td><td class="colon-col">:</td><td><span id="print-nis">...</span></td></tr>
                <tr><td class="label-col">Tahun Ajaran</td><td class="colon-col">:</td><td>2025/2026</td></tr>
            </table>

            <table class="nilai-table">
                <thead>
                    <tr><th style="width: 30px;">No</th><th>Mata Pelajaran</th><th style="width: 50px;">KKM</th><th style="width: 50px;">Nilai</th><th style="width: 100px;">Predikat</th></tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="sub-header">1. Pendalaman Agama Islam</td></tr>
                    <tr><td>1.</td><td class="text-left">Tahsin & Tahfidz</td><td>75</td><td id="rpt-tahfidz-val">0</td><td id="rpt-tahfidz-pred">-</td></tr>
                    <tr><td>2.</td><td class="text-left">Hadits</td><td>70</td><td id="rpt-hadits-val">0</td><td id="rpt-hadits-pred">-</td></tr>
                    <tr><td>3.</td><td class="text-left">Tauhid</td><td>70</td><td id="rpt-tauhid-val">0</td><td id="rpt-tauhid-pred">-</td></tr>
                    <tr><td>4.</td><td class="text-left">Fiqih Ibadah</td><td>70</td><td id="rpt-fiqih-val">0</td><td id="rpt-fiqih-pred">-</td></tr>

                    <tr><td colspan="5" class="sub-header">2. Pendalaman Bahasa Arab</td></tr>
                    <tr><td>5.</td><td class="text-left">Nahwu</td><td>65</td><td id="rpt-nahwu-val">0</td><td id="rpt-nahwu-pred">-</td></tr>
                    <tr><td>6.</td><td class="text-left">Shoraf</td><td>65</td><td id="rpt-shoraf-val">0</td><td id="rpt-shoraf-pred">-</td></tr>
                    <tr><td>7.</td><td class="text-left">Muhadatsah</td><td>65</td><td id="rpt-muhadatsah-val">0</td><td id="rpt-muhadatsah-pred">-</td></tr>
                    <tr><td>8.</td><td class="text-left">Aqidah Akhlak</td><td>70</td><td id="rpt-akhlak-val">0</td><td id="rpt-akhlak-pred">-</td></tr>
                </tbody>
            </table>

            <h4 style="margin-bottom: 5px; font-size: 10pt;">Rekapitulasi</h4>
            <table class="rekap-table">
                <thead><tr><th>Aspek Penilaian</th><th>Rata-Rata</th><th>Kesimpulan</th></tr></thead>
                <tbody>
                    <tr><td>Bidang Studi Agama</td><td id="rpt-rata-islam">0</td><td>Baik</td></tr>
                    <tr><td>Bidang Studi Bahasa</td><td id="rpt-rata-arab">0</td><td>Baik</td></tr>
                </tbody>
            </table>

            <div style="margin-top: 10px;">
                <b>Catatan Ustadz/Ustadzah:</b>
                <div class="catatan-box" id="rpt-catatan">-</div>
            </div>

            <div class="kenaikan-box" id="rpt-kenaikan">KEPUTUSAN: NAIK KE KELAS BERIKUTNYA</div>

            <div class="signature-section">
                <div class="sig-block"><p>Mengetahui,<br>Wali Murid</p><div class="sig-space"></div><p class="sig-name">( .................................... )</p></div>
                <div class="sig-block"><p>Wonogiri, <span id="print-date">...</span><br>Kepala Pesantren</p><div class="sig-space"></div><p class="sig-name">Ust. Abu Falih Rasyid</p></div>
            </div>
        </div>
    </div>

    <!-- ================= LOGIC JAVASCRIPT ================= -->
    <script>
        const subjects = [
            { id: 'tahfidz', name: "Tahsin & Tahfidz" },
            { id: 'hadits', name: "Hadits" },
            { id: 'tauhid', name: "Tauhid" },
            { id: 'fiqih', name: "Fiqih Ibadah" },
            { id: 'nahwu', name: "Nahwu" },
            { id: 'shoraf', name: "Shoraf" },
            { id: 'muhadatsah', name: "Muhadatsah" },
            { id: 'akhlak', name: "Aqidah Akhlak" }
        ];

        const predikatOptions = ["Mumtaz", "Jayyid Jiddan", "Jayyid", "Maqbul", "Rasib"];

        const defaultDbSantri = {
            "12345": {
                nama: "Muhammad",
                gender: "putra",
                catatan: "Ananda rajin dan berakhlak mulia. Pertahankan hafalan.",
                naikKelas: true,
                nilai: { 
                    tahfidz: 95, tahfidz_pred: "Mumtaz", hadits: 90, hadits_pred: "Mumtaz",
                    tauhid: 85, tauhid_pred: "Jayyid Jiddan", fiqih: 88, fiqih_pred: "Jayyid Jiddan",
                    nahwu: 80, nahwu_pred: "Jayyid Jiddan", shoraf: 75, shoraf_pred: "Jayyid",
                    muhadatsah: 85, muhadatsah_pred: "Jayyid Jiddan", akhlak: 90, akhlak_pred: "Mumtaz"
                },
                spp: [ { bulan: "Januari", lunas: true }, { bulan: "Februari", lunas: false } ]
            },
            "67890": {
                nama: "Fatimah",
                gender: "putri",
                catatan: "Rajin Murajaah.",
                naikKelas: true,
                nilai: { 
                    tahfidz: 92, tahfidz_pred: "Mumtaz", hadits: 88, hadits_pred: "Jayyid Jiddan",
                    tauhid: 85, tauhid_pred: "Jayyid Jiddan", fiqih: 90, fiqih_pred: "Mumtaz",
                    nahwu: 85, nahwu_pred: "Jayyid Jiddan", shoraf: 80, shoraf_pred: "Jayyid Jiddan",
                    muhadatsah: 88, muhadatsah_pred: "Jayyid Jiddan", akhlak: 95, akhlak_pred: "Mumtaz"
                },
                spp: [ { bulan: "Januari", lunas: true } ]
            }
        };

        const defaultPengumuman = [{ tgl: "12 Feb 2026", judul: "Info Libur", isi: "Libur Awal Ramadhan dimulai tanggal 1 Maret." }];

        let dbSantri = JSON.parse(localStorage.getItem('siap_dbSantri')) || defaultDbSantri;
        let listPengumuman = JSON.parse(localStorage.getItem('siap_pengumuman')) || defaultPengumuman;
        let currentUser = null;
        let currentRole = null; // 'putra' atau 'putri' untuk pengajar

        function saveData() {
            localStorage.setItem('siap_dbSantri', JSON.stringify(dbSantri));
            localStorage.setItem('siap_pengumuman', JSON.stringify(listPengumuman));
        }

        // --- LOGIN LOGIC ---
        function handleLogin() {
            const user = document.getElementById('usernameInput').value.trim();
            const pass = document.getElementById('passwordInput').value.trim();

            if (!user || !pass) { showToast("Masukkan Username & Password!"); return; }
            document.body.classList.remove('theme-female'); 
            currentRole = null; 

            if (user === 'ustadz') {
                if(pass === '932') {
                    currentRole = 'putra';
                    document.getElementById('staff-title').innerText = "Panel Ustadz";
                    document.getElementById('banner-salam').innerText = "Ahlan Wa Sahlan, Ustadz";
                    switchPage('staff-dashboard');
                    showToast("Alhamdulillah login berhasil Ustadz");
                } else showToast("Afwan diteliti kembali password / username nya");
            } 
            else if (user === 'ustadzah') {
                if(pass === '932') {
                    currentRole = 'putri';
                    document.body.classList.add('theme-female'); 
                    document.getElementById('staff-title').innerText = "Panel Ustadzah";
                    document.getElementById('banner-salam').innerText = "Ahlan Wa Sahlan, Ustadzah";
                    switchPage('staff-dashboard');
                    showToast("Alhamdulillah login berhasil Ustadzah");
                } else showToast("Afwan diteliti kembali password / username nya");
            }
            else if (dbSantri[user]) {
                if(pass === '123') {
                    const data = dbSantri[user];
                    currentUser = user;
                    if(data.gender === 'putri') document.body.classList.add('theme-female');
                    document.getElementById('wali-nama-santri').innerText = data.nama;
                    switchPage('wali-dashboard');
                    showToast("Alhamdulillah berhasil login");
                } else showToast("Afwan diteliti kembali password / username nya");
            } else showToast("Afwan diteliti kembali password / username nya");
        }

        function switchPage(pageId) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('staff-dashboard').classList.add('hidden');
            document.getElementById('wali-dashboard').classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        }

        function logout() { if(confirm("Mau keluar aplikasi?")) location.reload(); }

        // --- FILTER HELPER ---
        function isVisibleForTeacher(santriGender) {
            if (!currentRole) return true; 
            return santriGender === currentRole;
        }

        // --- MANAJEMEN SANTRI (SEARCH & DELETE) ---
        function openModal(id) { document.getElementById(id).classList.add('active'); if(id === 'modal-data-santri') refreshListSantri(); }
        function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); }
        function showToast(msg) { const t = document.getElementById("toast"); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }

        function tambahSantriBaru() {
            const nama = document.getElementById('new-nama').value;
            const nis = document.getElementById('new-nis').value;
            const gender = document.getElementById('new-gender').value;
            if(!nama || !nis) return alert("Data tidak lengkap!");
            if(dbSantri[nis]) return alert("NIS sudah ada!");
            
            // Validasi: Ustadz tidak boleh tambah Putri (untuk kerapian)
            if(currentRole && gender !== currentRole) {
                alert(`Maaf, Anda hanya dapat menambahkan santri ${currentRole === 'putra' ? 'Putra' : 'Putri'}.`);
                return;
            }

            let emptyNilai = {};
            subjects.forEach(sub => { emptyNilai[sub.id] = 0; emptyNilai[sub.id + '_pred'] = "Maqbul"; });
            dbSantri[nis] = { nama, gender, nilai: emptyNilai, spp: [], catatan: "", naikKelas: true };
            saveData(); showToast("Santri ditambahkan!"); refreshListSantri();
        }

        function hapusSantri(nis) {
            if(confirm("Yakin ingin menghapus data santri ini? Data nilai dan SPP akan hilang permanen.")) {
                delete dbSantri[nis];
                saveData();
                showToast("Data santri dihapus.");
                refreshListSantri();
            }
        }

        function refreshListSantri() {
            const list = document.getElementById('list-santri-display'); 
            const counter = document.getElementById('count-santri');
            list.innerHTML = "";
            let count = 0;

            for(let nis in dbSantri) { 
                // FILTER HANYA SESUAI GENDER
                if (isVisibleForTeacher(dbSantri[nis].gender)) {
                    const lbl = dbSantri[nis].gender === 'putra' ? 'Santri' : 'Santriwati';
                    list.innerHTML += `
                        <li>
                            <span>${dbSantri[nis].nama} (${nis}) - <b>${lbl}</b></span>
                            <button class="btn-delete" onclick="hapusSantri('${nis}')">Hapus</button>
                        </li>`; 
                    count++;
                }
            }
            counter.innerText = `Total: ${count}`;
        }

        function filterSantriList() {
            const input = document.getElementById('search-santri');
            const filter = input.value.toLowerCase();
            const ul = document.getElementById('list-santri-display');
            const li = ul.getElementsByTagName('li');

            for (let i = 0; i < li.length; i++) {
                const text = li[i].textContent || li[i].innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    li[i].style.display = "flex"; // Sesuaikan display flex list item
                } else {
                    li[i].style.display = "none";
                }
            }
        }

        function bukaModalInputNilai() {
            const select = document.getElementById('select-santri-input'); select.innerHTML = "";
            let count = 0;
            for(let nis in dbSantri) {
                if (isVisibleForTeacher(dbSantri[nis].gender)) {
                    let opt = document.createElement('option'); opt.value = nis; opt.text = `${dbSantri[nis].nama} (${nis})`; select.appendChild(opt);
                    count++;
                }
            }
            if(count === 0) { alert("Belum ada data santri yang sesuai."); return; }
            openModal('modal-input-nilai'); generateFormNilai(); loadNilaiToForm();
        }

        function generateFormNilai() {
            const tbody = document.getElementById('tbody-nilai-input'); tbody.innerHTML = "";
            subjects.forEach(sub => {
                let optionsHTML = ""; predikatOptions.forEach(opt => { optionsHTML += `<option value="${opt}">${opt}</option>`; });
                const row = `<tr><td>${sub.name}</td>
                    <td><input type="number" id="in-${sub.id}" class="form-control" oninput="autoPredikat('${sub.id}')" placeholder="0-100"></td>
                    <td><select id="sel-${sub.id}" class="select-predikat">${optionsHTML}</select></td></tr>`;
                tbody.innerHTML += row;
            });
        }

        function autoPredikat(id) {
            const val = parseInt(document.getElementById('in-'+id).value) || 0;
            const sel = document.getElementById('sel-'+id);
            if(val >= 90) sel.value = "Mumtaz"; else if(val >= 80) sel.value = "Jayyid Jiddan"; else if(val >= 70) sel.value = "Jayyid"; else if(val >= 60) sel.value = "Maqbul"; else sel.value = "Rasib";
        }

        function loadNilaiToForm() {
            const nis = document.getElementById('select-santri-input').value; if(!nis) return;
            const data = dbSantri[nis];
            subjects.forEach(sub => {
                document.getElementById('in-'+sub.id).value = data.nilai[sub.id];
                document.getElementById('sel-'+sub.id).value = data.nilai[sub.id + '_pred'] || "Maqbul";
            });
            document.getElementById('input-catatan').value = data.catatan || "";
            const radios = document.getElementsByName('naikKelas');
            if(data.naikKelas === false) radios[1].checked = true; else radios[0].checked = true;
        }

        function simpanDataNilai() {
            const nis = document.getElementById('select-santri-input').value;
            subjects.forEach(sub => {
                dbSantri[nis].nilai[sub.id] = parseInt(document.getElementById('in-'+sub.id).value) || 0;
                dbSantri[nis].nilai[sub.id + '_pred'] = document.getElementById('sel-'+sub.id).value;
            });
            dbSantri[nis].catatan = document.getElementById('input-catatan').value;
            const radios = document.getElementsByName('naikKelas');
            dbSantri[nis].naikKelas = radios[0].checked; 
            saveData(); closeAllModals(); showToast("Data Rapot Tersimpan!");
        }

        function bukaModalKelolaSPP() {
            const tbody = document.getElementById('tbody-spp-ustadz'); tbody.innerHTML = "";
            for (let nis in dbSantri) {
                if (isVisibleForTeacher(dbSantri[nis].gender)) {
                    const s = dbSantri[nis];
                    s.spp.forEach((item, i) => {
                        const row = `<tr><td>${s.nama}</td><td>${item.bulan} <i class="fas fa-pen edit-month-btn" onclick="renameBulan('${item.bulan}')"></i></td>
                            <td><span class="badge ${item.lunas?'badge-lunas':'badge-belum'}">${item.lunas?'LUNAS':'BELUM'}</span></td>
                            <td><button class="btn-card" style="padding:2px 8px;" onclick="toggleSPP('${nis}', ${i})">Ubah</button></td></tr>`;
                        tbody.innerHTML += row;
                    });
                }
            }
            openModal('modal-kelola-spp');
        }
        function toggleSPP(nis, i) { dbSantri[nis].spp[i].lunas = !dbSantri[nis].spp[i].lunas; saveData(); bukaModalKelolaSPP(); }
        function tambahBulanSPP() { const b = prompt("Nama Bulan Baru:"); if(!b) return; for(let n in dbSantri) dbSantri[n].spp.push({bulan:b, lunas:false}); saveData(); bukaModalKelolaSPP(); }
        function renameBulan(old) { const n = prompt("Ubah bulan:", old); if(!n) return; for(let x in dbSantri) dbSantri[x].spp.forEach(s => { if(s.bulan===old) s.bulan=n; }); saveData(); bukaModalKelolaSPP(); }

        // --- RAPOT PRINT ---
        function prepareRapotHTML(nis) {
            const data = dbSantri[nis];
            const n = data.nilai;
            document.getElementById('print-nama').innerText = data.nama;
            document.getElementById('print-nis').innerText = nis;
            document.getElementById('print-date').innerText = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});

            let totalIslam = 0, totalArab = 0;
            subjects.forEach(sub => {
                document.getElementById(`rpt-${sub.id}-val`).innerText = n[sub.id];
                document.getElementById(`rpt-${sub.id}-pred`).innerText = n[sub.id + '_pred'];
                if(['tahfidz','hadits','tauhid','fiqih'].includes(sub.id)) totalIslam += n[sub.id]; else totalArab += n[sub.id];
            });
            document.getElementById('rpt-rata-islam').innerText = Math.round(totalIslam / 4);
            document.getElementById('rpt-rata-arab').innerText = Math.round(totalArab / 4);
            document.getElementById('rpt-catatan').innerText = data.catatan || "-";
            document.getElementById('rpt-kenaikan').innerText = data.naikKelas ? "KEPUTUSAN: NAIK KE KELAS BERIKUTNYA" : "KEPUTUSAN: TINGGAL DI KELAS SAAT INI";
        }

        function showPreview() {
            openModal('modal-preview-rapot');
            const element = document.getElementById("printable-area");
            const container = document.getElementById("rapot-image-container");
            const actions = document.getElementById("action-buttons");
            const loading = document.getElementById("loading-text");
            container.innerHTML = ""; loading.style.display = "block"; actions.style.display = "none";
            setTimeout(() => {
                html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => {
                    generatedCanvas = canvas;
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL("image/jpeg", 0.9);
                    img.style.maxWidth = "100%"; img.style.border = "1px solid #ccc";
                    container.appendChild(img);
                    loading.style.display = "none"; actions.style.display = "flex";
                });
            }, 500);
        }

        function setupPreviewUstadz() { 
            let foundNIS = null;
            for (let nis in dbSantri) {
                if (isVisibleForTeacher(dbSantri[nis].gender)) {
                    foundNIS = nis;
                    break;
                }
            }
            if(foundNIS) { prepareRapotHTML(foundNIS); showPreview(); } 
            else { alert("Data santri kosong atau tidak sesuai hak akses."); }
        }
        
        function generateRapotForWali() { prepareRapotHTML(currentUser); showPreview(); }
        function downloadJPG() { const link = document.createElement('a'); link.download = "Rapot.jpg"; link.href = generatedCanvas.toDataURL("image/jpeg", 0.9); link.click(); }
        function downloadPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
            const imgData = generatedCanvas.toDataURL('image/jpeg', 0.9);
            const imgWidth = 210; const imgHeight = generatedCanvas.height * imgWidth / generatedCanvas.width;
            doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight); doc.save("Rapot.pdf");
        }

        function simpanPengumuman() { const j = document.getElementById('judul-pengumuman').value; const i = document.getElementById('isi-pengumuman').value; if(!j) return; listPengumuman.unshift({tgl: new Date().toLocaleDateString(), judul:j, isi:i}); saveData(); closeAllModals(); showToast("Terkirim"); }
        function bukaModalPengumumanWali() { const c = document.getElementById('container-pengumuman-wali'); c.innerHTML=""; listPengumuman.forEach(x => c.innerHTML += `<div class="news-item"><span class="news-date">${x.tgl}</span><b>${x.judul}</b><p>${x.isi}</p></div>`); openModal('modal-lihat-pengumuman'); }
        function lihatSPPWali() { const tb = document.getElementById('tbody-spp-wali'); tb.innerHTML=""; dbSantri[currentUser].spp.forEach(x => tb.innerHTML += `<tr><td>${x.bulan}</td><td>Rp 500rb</td><td>${x.lunas?'LUNAS':'BELUM'}</td></tr>`); openModal('modal-spp-wali'); }
    </script>
</body>
</html>
